name: gha action ci

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/ci.yaml
      - 'action-*/**' # By convention please name your actions action-<action-name>
  pull_request:
    branches:
      - main
    paths:
      - .github/workflows/ci.yaml
      - 'action-*/**' # By convention please name your actions action-<action-name>

jobs:
  update_tags:
    name: ci tests
    runs-on: ubuntu-22.04
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set up Git
      run: |
        git config user.name "GitHub Actions"
        git config user.email "<>"

    - name: Determine Changed Actions
      id: changed_actions
      run: |
        CHANGED_ACTIONS=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | awk -F '/' '{print $1}' | uniq)
        echo "changed_actions=${CHANGED_ACTIONS}" >> $GITHUB_ENV

    - name: Verify Version Update and README.md Presence
      if: steps.changed_actions.outputs.changed_actions != ''
      run: |
        for action in ${{ env.changed_actions }}; do
          if git diff --quiet "$action/VERSION"; then
            echo "ERROR: $action/VERSION has not been updated."
            exit 1
          fi
          if [ ! -f "$action/README.md" ]; then
            echo "ERROR: $action/README.md not found."
            exit 1
          fi
          if [ ! -f "$action/action.yaml" ]; then
            echo "ERROR: $action/action.yaml does not exist."
            exit 1
          fi
        done

    - name: Update Tags
      if: steps.changed_actions.outputs.changed_actions != ''
      run: |
        for action in ${{ steps.changed_actions.outputs.changed_actions }}; do
          cd "$action"
          version=$(<VERSION)
          git tag -a "v$version" -m "Release $version"
          git push origin "v$version"
          cd ..
        done
